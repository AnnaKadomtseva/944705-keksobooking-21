(()=>{"use strict";window.utils={pressEnter:(e,t)=>{"Enter"===e.key&&t()},pressMouseButton:(e,t)=>{0===e.button&&t()},pressEsc:(e,t)=>{"Escape"===e.key&&t()}},(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o=(e,t,o,n)=>{const r=new XMLHttpRequest;return r.responseType="json",r.addEventListener("load",(()=>{200===r.status?o(r.response):n(`Статус ответа: ${r.status} ${r.statusText}`)})),r.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${r.timeout} мс`)})),r.timeout=1e4,r.open(e,t),r};window.backend={upload:(e,n,r)=>{o("POST",t,n,r).send(e)},load:(t,n)=>{o("GET",e,t,n).send()}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__upload input[type=file]"),r=document.querySelector(".ad-form__photo"),i=e=>{o.src=e},a=e=>{const t=document.createElement("img");t.src=e,t.width=70,t.height=70,t.style.borderRadius="5px",r.appendChild(t)},d=(t,o)=>{const n=t.files[0];if(n){const t=n.name.toLowerCase();if(e.some((e=>t.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(e=>{o(e.target.result)})),e.readAsDataURL(n)}}};t.addEventListener("change",(()=>{d(t,i)})),n.addEventListener("change",(()=>{d(n,a)})),window.image={remove:()=>{o.src="img/muffin-grey.svg";const e=r.querySelectorAll("img");e&&e.forEach((e=>{e.remove()}))}}})(),(()=>{const e={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},t={BUNGALO:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4},o=document.querySelector(".ad-form"),n=document.querySelectorAll("fieldset, select"),r=o.querySelector("#title"),i=o.querySelector("#capacity"),a=o.querySelector("#room_number"),d=i.querySelectorAll("option"),s=o.querySelector("#timein"),c=o.querySelector("#timeout"),l=o.querySelector("#type"),u=o.querySelector("#price"),m=()=>{n.forEach((e=>{e.disabled=!e.disabled}))};m();const p=(e,t)=>{e.style.border=t};o.addEventListener("invalid",(e=>{p(e.target,"3px solid red")}),!0);const f=e=>{e.checkValidity()&&p(e,"")};r.addEventListener("change",(()=>{f(r)})),r.addEventListener("input",(()=>{const e=r.value.length;e<30?r.setCustomValidity(`Ещё ${30-e} симв.`):e>100?r.setCustomValidity(`Удалите лишние ${e-100} симв.`):r.setCustomValidity(""),r.reportValidity()})),r.addEventListener("invalid",(()=>{r.validity.tooShort?r.setCustomValidity("Заголовок должен состоять минимум из 30 символов"):r.validity.tooLong?r.setCustomValidity("Заголовок не должен превышать 100 символов"):r.validity.valueMissing?r.setCustomValidity("Обязательное поле"):r.setCustomValidity("")})),u.addEventListener("input",(()=>{const e=u.value.length;e<0?u.setCustomValidity(`Цена для данного типа жилья не может быть менее ${u.min} p.`):e>1e6?u.setCustomValidity("Цена не может быть более 1000000 р."):u.setCustomValidity(""),u.reportValidity()})),u.addEventListener("change",(()=>{f(u)}));const v=()=>{const t=a.value;d.forEach((o=>{o.selected=e[t][0]===o.value;let n=!(e[t].indexOf(o.value)>=0);o.disabled=n,o.hidden=n}))};v(),a.addEventListener("change",(()=>{v()})),i.addEventListener("change",(()=>{f(i)})),l.addEventListener("change",(e=>{const o=t[e.target.value.toUpperCase()];u.min=o,u.placeholder=o})),s.addEventListener("change",(()=>{c.value=s.value})),c.addEventListener("change",(()=>{s.value=c.value})),window.form={formElement:o,activate:()=>{o.classList.remove("ad-form--disabled"),m(),window.filter.form.addEventListener("change",window.filter.onFilterChange)},deactivate:()=>{m(),o.classList.add("ad-form--disabled"),o.reset(),window.filter.form.removeEventListener("change",window.filter.onFilterChange),p(r,""),p(u,""),p(i,"")}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e={low:{start:0,end:1e4},middle:{start:1e4,end:5e4},high:{start:5e4,end:1/0}},t=Array.from(document.querySelector(".map__filters").children),o=document.querySelector(".map__filters"),n={"housing-type":(e,t)=>t.value===e.offer.type,"housing-price":(t,o)=>t.offer.price>=e[o.value].start&&t.offer.price<e[o.value].end,"housing-rooms":(e,t)=>t.value===e.offer.rooms.toString(),"housing-guests":(e,t)=>t.value===e.offer.guests.toString(),"housing-features":(e,t)=>Array.from(t.querySelectorAll("input[type=checkbox]:checked")).every((t=>e.offer.features.some((e=>e===t.value))))},r=()=>{o.reset()};r();const i=window.debounce((()=>{window.pin.remove(),window.card.remove(),window.pin.render((e=>{let o,r=[];for(let i=0;i<e.length&&5!==r.length;i++)o=t.every((t=>"any"===t.value||n[t.id](e[i],t))),o&&r.push(e[i]);return r})(window.map.offers()))}));window.filter={PINS_MAX:5,form:o,onFilterChange:i,deactivate:r}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=()=>{const e=t.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")};window.pin={render:n=>{const r=document.createDocumentFragment();n.slice(0,8).forEach((t=>{r.appendChild((t=>{let n=e.cloneNode(!0);n.style.left=t.location.x-25+"px",n.style.top=t.location.y-70+"px";const r=n.querySelector("img");r.src=t.author.avatar,r.alt=t.offer.title;const i=()=>{o(),n.classList.add("map__pin--active"),window.card.remove(),window.card.create(t)};return n.addEventListener("click",i),n.addEventListener("keydown",(e=>{window.utils.pressEnter(e,i)})),n})(t))})),t.appendChild(r)},remove:()=>{t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},deactivate:o}})(),(()=>{const e={PALACE:"Дворец",FLAT:"Квартира",HOUSE:"Дом",BUNGALOW:"Бунгало"},t=document.querySelector(".map"),o=document.querySelector("#card").content.querySelector(".map__card"),n=t.querySelector(".map__filters-container");window.card={mapElement:t,remove:()=>{const e=t.querySelector(".map__card");e&&e.remove()},create:t=>{const r=o.cloneNode(!0),i=r.querySelector(".popup__avatar");t.author.avatar?i.src=t.author.avatar:i.remove();const a=r.querySelector(".popup__title");t.offer.title?a.textContent=t.offer.title:a.remove();const d=r.querySelector(".popup__text--address");t.offer.address?d.textContent=t.offer.address:d.remove();const s=r.querySelector(".popup__text--price");t.offer.price?s.textContent=t.offer.price+"  ₽/ночь":s.remove();const c=r.querySelector(".popup__type");t.offer.type?c.textContent=e[t.offer.type.toUpperCase()]:c.remove();const l=r.querySelector(".popup__text--capacity");t.offer.rooms&&t.offer.guests?l.textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`:l.remove();const u=r.querySelector(".popup__text--time");t.offer.checkin&&t.offer.checkout?u.textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`:u.remove();const m=r.querySelector(".popup__features");t.offer.features?(m.innerHTML="",m.appendChild((e=>{const t=document.createDocumentFragment();return e.offer.features.forEach((e=>{const o=document.createElement("li");o.className="popup__feature popup__feature--"+e,t.appendChild(o)})),t})(t))):m.remove();const p=r.querySelector(".popup__description");t.offer.description?p.textContent=t.offer.description:p.remove();const f=r.querySelector(".popup__photos");t.offer.photos.length?((e,t)=>{const o=e.offer.photos,n=t.children[0],r=document.createDocumentFragment();o.forEach(((e,t)=>{const i=n.cloneNode(!0);i.src=o[t],r.appendChild(i)})),t.appendChild(r),n.remove()})(t,f):f.remove(),n.insertAdjacentElement("beforebegin",r);const v=e=>{window.utils.pressEsc(e,y)},y=()=>{window.pin.deactivate(),r.remove(),document.removeEventListener("keydown",v)};return r.querySelector(".popup__close").addEventListener("click",(()=>{y()})),document.addEventListener("keydown",v),r}}})(),(()=>{const e=87,t=document.querySelector(".map__pin--main"),o=document.querySelector("#address");let n=[];const r=(e,t)=>{o.value=`${e}, ${t}`},i=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: orange;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="35px",t.textContent=e,document.main.insertAdjacentElement("afterbegin",t)},a=e=>{const t=600+Math.floor(32.5),o=375+Math.floor(32.5);r(t,e?462:o)};a();const d=e=>{e.forEach((e=>{e.offer&&n.push(e)})),window.pin.render(n.slice(0,window.filter.PINS_MAX))},s=()=>{window.card.mapElement.classList.remove("map--faded"),window.backend.load(d,i),window.form.activate(),a(!0)};t.addEventListener("mousedown",(o=>{o.preventDefault(),window.card.mapElement.classList.contains("map--faded")&&window.utils.pressMouseButton(o,s);let n=o.clientX-t.getBoundingClientRect().left,i=o.clientY-t.getBoundingClientRect().top;const a=o=>{o.preventDefault();let a={x:o.clientX-n-window.card.mapElement.getBoundingClientRect().left,y:o.clientY-i-window.card.mapElement.getBoundingClientRect().top};a.y<43?a.y=43:a.y>543&&(a.y=543),a.x<0+Math.floor(32.5)?a.x=0-Math.floor(32.5):a.x>1200-Math.floor(32.5)&&(a.x=1200-Math.floor(32.5)),t.style.left=a.x+"px",t.style.top=a.y+"px",(()=>{const o=parseInt(t.style.left,10)+Math.floor(32.5),n=parseInt(t.style.top,10)+e;r(o,n)})()},d=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",d)})),t.addEventListener("keydown",(e=>{window.utils.pressEnter(e,s)})),window.map={offers:()=>n,getPosition:()=>{a(),t.style.left="600px",t.style.top="375px"}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector(".ad-form__reset"),o=document.querySelector("#error").content.querySelector(".error"),n=document.querySelector("#success").content.querySelector(".success"),r=()=>{document.querySelector(".error").remove(),document.removeEventListener("keydown",a)},i=()=>{r()},a=e=>{window.utils.pressEsc(e,r)},d=()=>{e.insertAdjacentElement("afterbegin",o),document.querySelector(".error__button").addEventListener("click",i),o.addEventListener("click",i),document.addEventListener("keydown",a)},s=()=>{document.querySelector(".success").remove(),document.removeEventListener("keydown",l)},c=()=>{s()},l=e=>{window.utils.pressEsc(e,s)},u=()=>{window.card.mapElement.classList.add("map--faded"),window.form.deactivate(),window.pin.remove(),window.card.remove(),window.filter.deactivate(),window.map.getPosition(),window.image.remove()};t.addEventListener("click",(e=>{e.preventDefault(),u()}));const m=()=>{e.insertAdjacentElement("afterbegin",n),n.addEventListener("click",c),document.addEventListener("keydown",l),u()};window.form.formElement.addEventListener("submit",(e=>{window.backend.upload(new FormData(window.form.formElement),m,d),e.preventDefault()}))})()})();